name: Deploying Yadxy to EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Setup pnpm FIRST
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      # Setup Node with pnpm cache
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      # Install dependencies
      - name: Install deps
        run: pnpm install --frozen-lockfile

      # Build using turbo
      - name: Turbo build
        run: |
          pnpm turbo run build \
          --filter=server \
          --filter=web


      # Prepare deploy artifacts
      - name: Prepare deploy artifacts
        run: |
          mkdir -p deploy/api deploy/web deploy/shared/db

          # API
          cp apps/server/package.json deploy/api/
          cp -r apps/server/dist deploy/api/

          # WEB
          cp apps/web/package.json deploy/web/
          cp -r apps/web/.next deploy/web/
          cp -r apps/web/public deploy/web/public

          # DB
          cp packages/db/package.json deploy/shared/db/
          cp -r packages/db/dist deploy/shared/db/dist

      # Copy to EC2
      - name: Deploy to EC2
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy/*"
          target: "/srv/yadxy"

      # Restart PM2
     # - name: Restart PM2
      #  uses: appleboy/ssh-action@v1.0.3
       # with:
        #  host: ${{ secrets.EC2_HOST }}
         # username: ${{ secrets.EC2_USER }}
          #key: ${{ secrets.EC2_SSH_KEY }}
         # script: |
          #  cd /srv/yadxy
           # pm2 reload all
